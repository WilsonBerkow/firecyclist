<!DOCTYPE html>
<html>
    <head>
        <title>Firecyclist</title>
        <meta charset="UTF-8"/>
        <style>
            html, body {
                text-align: center;
                margin: 0;
                padding: 0;
                user-select: none;
                cursor: default;
                background: black;
                overflow: hidden;
            }
            #Main {
              background: white;
            }
        </style>
    </head>
    <body data-role="page">
        <div id="Main"></div>
        <script src="jquery-1.11.2.min.js"></script>
        <script src="jquery.mobile-1.4.5.min.js"></script>
        <script src="elm.js"></script>
        <script>
            (function () {
                var module = Elm.embed(Elm.Main, jQuery('#Main')[0], {taps: null, cur_touch: null, approx_time: Date.now()}),
                    pageScaleFactor = 1,
                    moduleOffsetX = 0,
                    resize = function () { // This zooms the page so that the Firecyclist module (initially always (576/2) by (1024/2) in dimensions), fits to the page.
                        var scaleX = jQuery(window).width() / (576 / 2),
                            scaleY = jQuery(window).height() / (1024 / 2),
                            unfitAxis;
                        pageScaleFactor = Math.min(scaleX, scaleY);
                        unfitAxis = pageScaleFactor === scaleX ? "y" : "x";
                        jQuery("body")
                            .css("-moz-transform-origin", "0 0")
                            .css("-moz-transform", "scale(" + pageScaleFactor + ")")
                            .css("-webkit-transform-origin", "0 0")
                            .css("-webkit-transform", "scale(" + pageScaleFactor + ")")
                            .css("-ms-transform-origin", "0 0")
                            .css("-ms-transform", "scale(" + pageScaleFactor + ")");
                        jQuery(document).width(576 / 2).height(1024 / 2);
                        if (unfitAxis === "x") {
                            moduleOffsetX = ((jQuery("body").width() - (576 / 2) * pageScaleFactor) / 2) / pageScaleFactor; // The last division, by pageScaleFactor, is there because the zoom done above will automatically scale this whole expression/offest by pageScaleFactor, so the division undoes that.
                            jQuery("#Main").css("position", "absolute").css("left", moduleOffsetX);
                        }
                    };
                resize();
                jQuery(document).tap(function (event) {
                    module.ports.taps.send({
                        "x": event.pageX / pageScaleFactor - moduleOffsetX,
                        "y": event.pageY / pageScaleFactor
                    });
                });
                setInterval(function () {
                    module.ports.approx_time.send(Date.now());
                }, 1000);
                (function () {
                    var touchesCount = 0,
                        curTouch = null,
                        updatePort = function () {
                            module.ports.cur_touch.send(curTouch);
                        },
                        calcPos = function (event) {
                            return {
                                "x": (typeof event.pageX === "number" ? event.pageX : event.originalEvent.changedTouches[0].pageX) / pageScaleFactor - moduleOffsetX,
                                "y": (typeof event.pageY === "number" ? event.pageY : event.originalEvent.changedTouches[0].pageY) / pageScaleFactor
                            };
                        };
                    jQuery(document).on("mousemove touchmove", function (event) {
                        var xy = calcPos(event);
                        if (curTouch !== null) {
                            curTouch.x = xy.x;
                            curTouch.y = xy.y;
                            updatePort();
                        }
                    });
                    jQuery(document).on("touchstart", function (event) {
                        var now = Date.now(), xy = calcPos(event);
                        curTouch = {
                            "t0": now,
                            "id": touchesCount,
                            "x0": xy.x,
                            "y0": xy.y,
                            "x":  xy.x,
                            "y":  xy.y
                        };
                        touchesCount += 1;
                        updatePort();
                    });
                    jQuery(document).on("touchend", function () {
                        curTouch = null;
                        updatePort();
                    });
                }());
            }());
        </script>
    </body>
</html>